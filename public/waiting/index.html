<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
  <title>Waiting - maruyu.work</title>
</head>

<body>
  <message-box></message-box>
  <header-element signin='required'></header-element>
  <div class="row justify-content-center" style="height:auto">
    <div class="login-form col-11 col-sm-11 col-md-11 col-lg-8 col-xl-7 col-xxl-6 mt-5">
      <h1>Waiting</h1>
      <h5>Apps</h5>
      <table class="table">
        <thead>
          <tr>
            <th scope="col">WaitingID</th>
            <th scope="col">appID</th>
            <th scope="col">OwnerID</th>
            <th scope="col">RegisteredAt</th>
            <th scope="col">Review</th>
          </tr>
        </thead>
        <tbody id='waitingApps'>
        </tbody>
      </table>
      <h5>Users</h5>
      <table class="table">
        <thead>
          <tr>
            <th scope="col">WaitingID</th>
            <th scope="col">UserID</th>
            <th scope="col">Email</th>
            <th scope="col">RegisteredAt</th>
            <th scope="col">Review</th>
          </tr>
        </thead>
        <tbody id='waitingUsers'>
        </tbody>
      </table>
    </div>
  </div>
  <script type='module'>
    import { get, post, showmessage } from '/js/utils.js'
    function ce({tag, text, appendto, attributes}){
      const elm = document.createElement(tag)
      if(text) elm.innerText = text
      if(attributes)
        for(let [k,v] of Object.entries(attributes)) elm.setAttribute(k,v)
      if(appendto) appendto.appendChild(elm)
      return elm
    }
    function createButton({waiting_id, text, appendto}){
      text = text.toLowerCase()
      console.assert(text == 'approve' || text == 'reject')
      const color = text == 'approve' ? 'success' : 'danger'
      const button = ce({tag:'button',text,attributes:{type:'button',class:`btn btn-sm btn-${color}`},appendto})
      button.addEventListener('click', e=>{
        post('/api/review_waiting', {waiting_id, review:text})
        .then(packet=>console.log(packet))
        .then(document.location.reload())
        .catch(packet=>{
          const { title, message } = packet.json()
          showmessage({title, message, color:'warning'})
        })
      })
    }
    function createUserRow({waiting_id, user_id, email, registered_at}){
      const tr = ce({tag:'tr'})
      ce({tag:'th', text:waiting_id, attributes:{scope:'row'}, appendto:tr})
      ce({tag:'td', text:user_id, appendto:tr})
      ce({tag:'td', text:email, appendto:tr})
      ce({tag:'td', text:registered_at, appendto:tr})
      const td = ce({tag:'td', appendto:tr})
      createButton({waiting_id, text:'Approve', appendto:td})
      createButton({waiting_id, text:'Reject', appendto:td})
      return tr
    }
    function createAppRow({waiting_id, app_id, owner_id, registered_at}){
      const tr = ce({tag:'tr'})
      ce({tag:'th', text:waiting_id, attributes:{scope:'row'}, appendto:tr})
      ce({tag:'td', text:app_id, appendto:tr})
      ce({tag:'td', text:owner_id, appendto:tr})
      ce({tag:'td', text:registered_at, appendto:tr})
      const td = ce({tag:'td', appendto:tr})
      createButton({waiting_id, text:'Approve', appendto:td})
      createButton({waiting_id, text:'Reject', appendto:td})
      return tr
    }
    function addRows({bodyid, rows}){
      const tbody = document.getElementById(bodyid)
      for(let row of rows) tbody.appendChild(row)
    }
    function refleshRows(bodyid){document.getElementById(bodyid).innerHTML=''}
    get('/api/get_waitings').then(packet=>{
      if(packet.json().title!="Waitings") throw Error("undefined exception")
      console.log(packet)
      const userrows = []
      const approws = []
      const { users, apps } = packet.json().details
      for(let user of users){
        const {waiting_id, user_id, email, registered_at} = user
        userrows.push(createUserRow({waiting_id, user_id, email, registered_at}))
      }
      for(let app of apps){
        const {waiting_id, app_id, user_id, registered_at} = app
        approws.push(createAppRow({waiting_id, app_id, owner_id:user_id, registered_at}))
      }
      refleshRows('waitingUsers')
      addRows({bodyid:'waitingUsers', rows:userrows})
      refleshRows('waitingApps')
      addRows({bodyid:'waitingApps', rows:approws})
    }).catch(packet=>{
      console.error(packet)
      const {title, message} = packet.json()
      showmessage({title, message, color:'warning'})
    })
  </script>
  <script type="module" src="/components/messagebox.js"></script>
  <script type="module" src="/components/header.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW"
    crossorigin="anonymous"></script>
</body>

</html>